name: update-fork

on:
  workflow_dispatch:
  push:
    branches:
      - fork
    
jobs:        
  update-fork:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@main
        with:
          path: mwp
          
      - uses: actions/checkout@main
        with:
          repository: goofw/mw
          path: mw

      - uses: actions/setup-node@main
      
      - run: |
          cd mwp
          npm i -g pnpm
          pnpm install --frozen-lockfile
          pnpm build
          cd -

          cd mw
          diff ../mwp/lib/index.js providers.js
          cp ../mwp/lib/index.js providers.js
          
          git config user.name $(git log -1 --pretty=format:'%an')
          git config user.email $(git log -1 --pretty=format:'%ae')
          git add .
          git diff-index --quiet HEAD || git commit -m "update sing-box $version"
          git push
          
      - uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 5
