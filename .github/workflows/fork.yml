name: update-fork

on:
  workflow_dispatch:
  push:
    branches:
      - fork
    
jobs:        
  update-fork:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@main
      - uses: actions/setup-node@main
      
      - env:
          PAT_FOR_MW: ${{ secrets.PAT_FOR_MW }}
        run: |
          npm i -g pnpm
          pnpm i --frozen-lockfile
          pnpm build

          git clone https://$PAT_FOR_MW@github.com/goofw/mw
          cd mw
          cp ../lib/index.js providers.js

          git config user.name $(git log -1 --pretty=format:'%an')
          git config user.email $(git log -1 --pretty=format:'%ae')
          git config --list
          git add .
          git diff-index --quiet HEAD || git commit -m "update"
          git push
          
      - uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 5
